name: Deploy EPIMETHEUS Docs

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install MkDocs
        run: |
          pip install mkdocs mkdocs-material

      - name: Generate DocsSite (Specs + Ref)
        run: |
          set -euo pipefail
          rm -rf DocsSite
          mkdir -p DocsSite

          python - <<'PY'
          import os, pathlib

          ROOT = pathlib.Path(".").resolve()
          DOCS = ROOT / "DocsSite"
          SPECS = DOCS / "specs"
          REF = DOCS / "ref"
          SPECS.mkdir(parents=True, exist_ok=True)
          REF.mkdir(parents=True, exist_ok=True)

          include_ext = {
            ".txt",
            ".json", ".yml", ".yaml",
            ".cs", ".uxml", ".uss", ".asmdef",
            ".xml", ".shader", ".cginc", ".hlsl",
            ".toml", ".ini", ".cfg",
            ".md"  # ← Refでは後で除外する（Specs側に集約するため）
          }

          exclude_dir_names = {
            ".git", ".github",  # ノイズ除外（必要なら .github は消してOK）
            "Library", "Temp", "Obj", "Build", "Logs",
            "UserSettings", ".plastic", ".vscode",
            "DocsSite"  # ★自己増殖防止
          }

          def should_skip_dir(p: pathlib.Path) -> bool:
            return any(part in exclude_dir_names for part in p.parts)

          def lang_from_ext(ext: str) -> str:
            return {
              ".cs":"csharp", ".json":"json", ".yml":"yaml", ".yaml":"yaml",
              ".uxml":"xml", ".uss":"css", ".xml":"xml",
              ".shader":"c", ".hlsl":"hlsl", ".cginc":"c",
              ".toml":"toml", ".ini":"ini", ".cfg":"ini", ".txt":"text"
            }.get(ext, "text")

          def safe_read_text(fp: pathlib.Path) -> str | None:
            try:
              return fp.read_text(encoding="utf-8")
            except UnicodeDecodeError:
              try:
                return fp.read_text(encoding="utf-8-sig")
              except Exception:
                return None

          def copy_tree(src_root: pathlib.Path, dst_root: pathlib.Path):
            for p in src_root.rglob("*"):
              if p.is_dir():
                continue
              if p.suffix == ".meta":
                continue
              rel = p.relative_to(src_root)
              dst = dst_root / rel
              dst.parent.mkdir(parents=True, exist_ok=True)
              dst.write_bytes(p.read_bytes())

          # --- Specs copy ---
          # 1) Assets/Docs -> DocsSite/specs/
          src_specs = ROOT / "Assets" / "Docs"
          if src_specs.exists():
            copy_tree(src_specs, SPECS)

          # 2) Assets/Features/<Feature>/Docs -> DocsSite/specs/Features/<Feature>/
          features_root = ROOT / "Assets" / "Features"
          if features_root.exists():
            for feature_dir in features_root.iterdir():
              if not feature_dir.is_dir():
                continue
              docs_dir = feature_dir / "Docs"
              if docs_dir.exists():
                copy_tree(docs_dir, SPECS / "Features" / feature_dir.name)

          # Specs index（入口）
          spec_lines = [
            "# Specs",
            "",
            "仕様書セクション。",
            "",
          ]
          if (SPECS / "Conventions" / "00_Index.md").exists():
            spec_lines.append("- [Conventions](Conventions/00_Index/)")
          # Features の Docs があれば列挙
          features_specs = (SPECS / "Features")
          if features_specs.exists():
            for d in sorted([p for p in features_specs.iterdir() if p.is_dir()], key=lambda x: x.name.lower()):
              # 代表ページは Feature 配下の index.md があれば優先、なければフォルダリンク
              if (d / "index.md").exists():
                spec_lines.append(f"- [Feature: {d.name}](Features/{d.name}/index/)")
              else:
                spec_lines.append(f"- Feature: {d.name} (see under Features/{d.name}/)")
          (SPECS / "index.md").write_text("\n".join(spec_lines) + "\n", encoding="utf-8")

          # --- Ref generate ---
          items: list[tuple[str, str]] = []
          count = 0

          for dirpath, dirnames, filenames in os.walk(ROOT):
            dp = pathlib.Path(dirpath)
            if should_skip_dir(dp):
              dirnames[:] = []
              continue
            dirnames[:] = [d for d in dirnames if d not in exclude_dir_names]

            for fn in filenames:
              src = dp / fn
              if src.suffix == ".meta":
                continue
              ext = src.suffix.lower()
              if ext not in include_ext:
                continue

              # ★ SpecsにMarkdownは集約。Refでは .md を生成しない（.md.mdも防ぐ）
              if ext == ".md":
                continue

              text = safe_read_text(src)
              if text is None:
                continue

              rel = src.relative_to(ROOT)

              # ★ 出力は「元ファイル名.ext.md」形式
              # 例: EnemyParams.json -> EnemyParams.json.md
              out_md = REF / rel.parent / (rel.name + ".md")
              out_md.parent.mkdir(parents=True, exist_ok=True)

              lang = lang_from_ext(ext)
              text = text.replace("```", "``\\`")

              out_md.write_text(
                f"# {rel}\n\n"
                f"`{rel}`\n\n"
                f"```{lang}\n{text}\n```\n",
                encoding="utf-8"
              )

              # ★ ref/index.md から見た相対リンク（ref/ を付けない）
              link = str(out_md.relative_to(REF)).replace("\\", "/")
              items.append((str(rel), link))
              count += 1

          items.sort()
          lines = ["# Reference", "", "自動生成された参照ページ。", "", "## Files"]
          for title, link in items[:2000]:
            lines.append(f"- [{title}]({link})")
          (REF / "index.md").write_text("\n".join(lines) + "\n", encoding="utf-8")

          # Site Home
          (DOCS / "index.md").write_text(
            "# 2024 EPIMETHEUS Docs\n\n"
            "- [Specs](specs/)\n"
            "- [Reference](ref/)\n",
            encoding="utf-8"
          )

          print(f"Generated reference pages: {count}")
          PY

      - name: Build site
        run: |
          mkdocs build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
    steps:
      - name: Deploy
        uses: actions/deploy-pages@v4